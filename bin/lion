#!/usr/bin/env bash
. ~/bin/globals.sh

showFile() {
    MIME="$(file --dereference --brief --mime-type -- "${FILE}")"
    FULL_NAME="$(realpath "$FILE")"

    # Implement rangers cache filename function.
    HASH=$(echo "from hashlib import sha1
print(sha1('${FULL_NAME}'.encode('utf-8', 'backslashreplace')).hexdigest())" | /bin/python3 -)

    FULL_CACHE_NAME="${CACHE}${HASH}.jpg"
    outnl $yellow "$FILE : $MIME"

    if [[ "$(basename "${PROGRAM_NAME}")" == "lioness" ]]; then
        scope.sh "${FULL_NAME}" $W $H "${FULL_CACHE_NAME}" True True | \bat -p --paging always
    else
        scope.sh "${FULL_NAME}" $W $H "${FULL_CACHE_NAME}" True True
    fi
}

PROGRAM_NAME="$0"
W=$(tput cols)
H=$(tput lines)
CACHE="${HOME}/.cache/ranger/ranger/"

if [[ ! -d "${CACHE}" ]]; then
    mkdir -p "${CACHE}"
fi

case $# in
    0)
        outnl $red "No files to cat!"
        ;;

    1)
        FILE=$1

        if [[ -e "$FILE" ]]; then
            showFile "$FILE"
        else
            outnl $red "File missing: $FILE"
        fi
        ;;

    *)
        for FILE in "$@"
        do
            if [[ -e "$FILE" ]]; then
                showFile "$FILE"
            else
                outnl $red "File missing: $FILE"
            fi
        done
        ;;
esac

